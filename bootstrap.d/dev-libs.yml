sources:
  - name: glib
    subdir: ports
    git: 'https://gitlab.gnome.org/GNOME/glib.git'
    tag: '2.70.3'
    version: '2.70.3'

packages:
  - name: double-conversion
    metadata:
      summary: Efficient binary-decimal and decimal-binary conversion routines for IEEE doubles
      description: This package provides a library with conversion routines for binary to decimal and decimal to binary with IEEE doubles.
      spdx: 'BSD-3-Clause'
      website: 'https://github.com/google/double-conversion'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['dev-libs']
    source:
      subdir: ports
      git: 'https://github.com/google/double-conversion.git'
      tag: 'v3.1.5'
      version: '3.1.5'
    tools_required:
      - cross-cmake
      - cross-toolchain
    pkgs_required:
      - mlibc
    configure:
      - args:
        - 'cmake'
        - '-DCMAKE_TOOLCHAIN_FILE=@SOURCE_ROOT@/scripts/CMakeToolchain-@OPTION:arch-triple@.txt'
        - '-DCMAKE_INSTALL_PREFIX=/usr'
        - '-DBUILD_SHARED_LIBS=ON'
        - '@THIS_SOURCE_DIR@'
        environ:
          CC: '@OPTION:arch-triple@-gcc'
          CXX: '@OPTION:arch-triple@-g++'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: elfutils
    source:
      subdir: ports
      url: 'https://sourceware.org/elfutils/ftp/0.187/elfutils-0.187.tar.bz2'
      format: 'tar.bz2'
      extract_path: 'elfutils-0.187'
      version: '0.187'
      patch-path-strip: 1
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['autoreconf', '-fvi']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - bzip2
      - xz-utils
      - zlib
      - zstd
      - argp-standalone
      - fts-standalone
      - obstack-standalone
      - libintl
      - libiconv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--build=x86_64-linux-gnu'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--program-prefix="eu-"'
        - '--disable-debuginfod'
        - '--disable-libdebuginfod'
        - '--disable-valgrind'
        - '--with-bzlib'
        - '--with-lzma'
        - '--with-zstd'
        - '--with-zlib'
        - '--disable-nls'
        - '--enable-thread-safety'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['rm', '-rv', '@THIS_COLLECT_DIR@/usr/bin']

  - name: glib
    from_source: glib
    tools_required:
      - cross-toolchain
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
    pkgs_required:
      - mlibc
      - libiconv
      - libintl
      - pcre
      - libffi
      - zlib
    configure:
      - args:
        - 'meson'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@.cross-file'
        - '--prefix=/usr'
        - '--libdir=lib'
        - '--buildtype=debugoptimized'
        - '-Dxattr=false'
        - '-Dtests=true'
        - '-Dinstalled_tests=true'
        - '@THIS_SOURCE_DIR@'
        environ:
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
    scripts:
        post_install:
          - args: ['glib-compile-schemas /usr/share/glib-2.0/schemas']
          - args: ['gio-querymodules /usr/lib/gio/modules']

  - name : gmp
    source:
      subdir: 'ports'
      hg: 'https://gmplib.org/repo/gmp-6.2/'
      tag: 'tip'
      version: '6.2'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['@THIS_SOURCE_DIR@/.bootstrap']
        - args: ['cp', '@THIS_SOURCE_DIR@/configfsf.guess', '@THIS_SOURCE_DIR@/config.guess']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/']
    tools_required:
      - cross-toolchain
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--enable-cxx'
        - '--disable-static'
        - '--docdir=/usr/share/doc/gmp-6.2.0'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: libexpat
    source:
      subdir: 'ports'
      git: 'https://github.com/libexpat/libexpat.git'
      tag: 'R_2_4_1'
      version: '2.4.1'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./buildconf.sh']
          workdir: '@THIS_SOURCE_DIR@/expat'
    tools_required:
      - cross-toolchain
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/expat/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        # We disable xmlwf to avoid building its documentation.
        - '--without-xmlwf'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: libffi
    source:
      subdir: 'ports'
      git: 'https://github.com/libffi/libffi.git'
      tag: 'v3.4.2'
      version: '3.4.2'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./autogen.sh']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/']
    tools_required:
      - cross-toolchain
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: libiconv
    source:
      subdir: 'ports'
      git: 'https://git.savannah.gnu.org/git/libiconv.git'
      # Last release tag is broken for us, use current master (07-12-2020)
      branch: 'master'
      commit: '0eb1068ceb77ba383c3ce2fc391ab40ef686c491'
      version: '1.16'
      tools_required:
        - cross-toolchain
        - cross-autoconf-archive
        - cross-gettext
      regenerate:
        - args: ['./gitsub.sh', 'pull']
        # Gnulib broke on commit e3174b6d1fdbe6ea2297bf8c8333f65f9d9d9588, so check out the one before that.
        - args: ['git', 'checkout', '766ec17a90f67e8cda78394e58a7fffb00f5a4b7']
          workdir: '@THIS_SOURCE_DIR@/gnulib'
        - args: ['./autogen.sh']
          environ:
            'NOCONFIGURE': 'yes'
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/libcharset/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-libtool/share/aclocal/libtool.m4',
            '@THIS_SOURCE_DIR@/m4/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-libtool/share/aclocal/libtool.m4',
            '@THIS_SOURCE_DIR@/libcharset/m4/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-libtool/share/libtool/build-aux/ltmain.sh',
            '@THIS_SOURCE_DIR@/libcharset/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-libtool/share/libtool/build-aux/ltmain.sh',
            '@THIS_SOURCE_DIR@/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-libtool/share/aclocal/ltversion.m4',
            '@THIS_SOURCE_DIR@/m4/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-libtool/share/aclocal/ltversion.m4',
            '@THIS_SOURCE_DIR@/libcharset/m4/']
        - args: ['autoreconf', '-fvi', '-I@THIS_SOURCE_DIR@/m4', '-I@THIS_SOURCE_DIR@/srcm4']
    tools_required:
      - cross-toolchain
      - cross-gettext
      - cross-bison
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--disable-nls'
        - '--enable-shared'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: libintl
    from_source: gettext
    tools_required:
      - cross-toolchain
      - cross-gettext
      - cross-bison
    pkgs_required:
      - libiconv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--without-emacs'
        - '--without-lispdir'
        # Normally this controls nls behavior in general, but the libintl
        # subdir is skipped unless this is explicitly set.
        - '--enable-nls'
        # This magic flag enables libintl.
        - '--with-included-gettext'
        - '--disable-c++'
        - '--disable-libasprintf'
        - '--disable-java'
        - '--enable-shared'
        - '--disable-static'
        - '--enable-threads=posix'
        - '--disable-curses'
        - '--without-git'
        - '--without-cvs'
        - '--without-bzip2'
        - '--without-xz'
    build:
      - args: ['make', '-C', 'gettext-runtime/intl', '-j@PARALLELISM@']
      - args: ['make', '-C', 'gettext-runtime/intl', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: libpipeline
    source:
      subdir: ports
      git: 'https://gitlab.com/cjwatson/libpipeline.git'
      tag: '1.5.4'
      version: '1.5.4'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - cross-toolchain
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libtasn
    source:
      subdir: ports
      git: 'https://gitlab.com/gnutls/libtasn1.git'
      tag: 'v4.17.0'
      version: '4.17.0'
      tools_required:
        - cross-toolchain
      regenerate:
        #- args: ['sed', '-i', 's/"SUBDIRS = lib src fuzz tests"/"SUBDIRS = lib src fuzz"/', '@THIS_SOURCE_DIR@/Makefile.am']
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - cross-toolchain
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-static'
        - '--disable-doc'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libtsm
    source:
      subdir: 'ports'
      git: 'git://people.freedesktop.org/~dvdhrm/libtsm'
      tag: 'libtsm-3'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./autogen.sh']
          environ:
            'NOCONFIGURE': 'yes'
    tools_required:
      - cross-toolchain
    pkgs_required:
      - libxkbcommon
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: libunistring
    architecture: '@OPTION:arch@'
    metadata:
      summary: Library for manipulating Unicode and C strings according to Unicode standard
      description: This package provides a library containing functions for manipulating Unicode strings and for manipulating C strings according to the Unicode standard.
      spdx: 'LGPL-3.0-or-later'
      website: 'https://www.gnu.org/software/libunistring/'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['dev-libs']
    source:
      subdir: 'ports'
      url: 'https://ftp.gnu.org/gnu/libunistring/libunistring-0.9.10.tar.xz'
      format: 'tar.xz'
      extract_path: 'libunistring-0.9.10'
      version: '0.9.10'
      tools_required:
        - cross-toolchain
      regenerate:
      - args: ['autoreconf', '-fvi']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--disable-static'
        - '--docdir=/usr/share/doc/libunistring-0.9.10'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name : mpc
    source:
      subdir: ports
      git: 'https://gitlab.inria.fr/mpc/mpc.git'
      tag: '1.2.1'
      version: '1.2.1'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['autoreconf', '-f', '-i']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - gmp
      - mpfr
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-static'
        - '--docdir=/usr/share/doc/mpc-1.2.1'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name : mpfr
    source:
      subdir: 'ports'
      url: 'https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz'
      format: 'tar.xz'
      extract_path: 'mpfr-4.1.0'
      version: '4.1.0'
      tools_required:
        - cross-autoconf-archive
        - cross-toolchain
      regenerate:
        - args: ['autoreconf', '-v', '-f', '-i', '--warnings=all,error']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - gmp
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--enable-static=no'
        - '--enable-shared=yes'
        - '--docdir=/usr/share/doc/mpfr-4.0.2'
        - '--with-pic'
        environ:
          # MPFR's configuration script misdetects cross-compilations. Hence,
          # set one of its internal variables to force it into the cross compilation path.
          'user_redefine_cc': 'yes'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: nettle
    source:
      subdir: 'ports'
      git: 'https://git.lysator.liu.se/nettle/nettle.git'
      tag: 'nettle_3.7.3_release_20210606'
      version: '3.7.3'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./.bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - gmp
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-static'
        - '--disable-documentation'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: openssl
    source:
      subdir: ports
      git: "https://github.com/openssl/openssl.git"
      tag: "OpenSSL_1_1_1l"
      version: "1.1.1l"
    tools_required:
      - cross-toolchain
    pkgs_required:
      - zlib
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/Configure"
          - "--prefix=/usr"
          - "--openssldir=/etc/ssl"
          - "--libdir=lib"
          - "linux-mlibc-x86_64"
          - "shared"
          - "zlib-dynamic"
          - "no-afalgeng"
        environ:
          CC: "@OPTION:arch-triple@-gcc"
          CXX: "@OPTION:arch-triple@-g++"
    build:
      - args: ["make", "-j@PARALLELISM@"]
      - args: ["sed", "-i", "/INSTALL_LIBS/s/libcrypto.a libssl.a//", "@THIS_BUILD_DIR@/Makefile"]
      - args: ["make", "DESTDIR=@THIS_COLLECT_DIR@", "MANSUFFIX=ssl", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"
      - args: ["mv", "@THIS_COLLECT_DIR@/usr/share/doc/openssl", "@THIS_COLLECT_DIR@/usr/share/doc/openssl-1.1.1j"]
      - args: ["cp", "-fr", "@THIS_SOURCE_DIR@/doc/.", "@THIS_COLLECT_DIR@/usr/share/doc/openssl-1.1.1j"]

  - name: pcre
    source:
      subdir: ports
      git: "https://github.com/vinix-os/pcre"
      tag: "1767"
      # Seems to be 8.45?
      version: "8.45"
      tools_required:
        - cross-autoconf-v2.69
        - cross-automake-v1.15
        - cross-libtool
        - cross-pkg-config
        - cross-autoconf-archive
      regenerate:
        - args: ["./autogen.sh"]
    tools_required:
      - cross-toolchain
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--host=@OPTION:arch-triple@"
          - "--prefix=/usr"
          - "--with-sysroot=@SYSROOT_DIR@" # Set libtool's lt_sysroot.
          - "--enable-unicode-properties"
          - "--enable-pcre8"
          - "--enable-pcre16"
          - "--enable-pcre32"
          - "--disable-static"
        environ:
          PKG_CONFIG_SYSROOT_DIR: "@BUILD_ROOT@/system-root"
          PKG_CONFIG_LIBDIR: "@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig"
    build:
      - args: ["make", "-j@PARALLELISM@"]
      - args: ["make", "DESTDIR=@THIS_COLLECT_DIR@", "install"]
