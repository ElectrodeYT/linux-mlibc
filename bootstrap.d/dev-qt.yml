sources:
  - name: qt6
    subdir: 'ports'
    # This may seem strange, but is actually correct
    git: 'https://code.qt.io/qt/qt5.git'
    tag: 'v6.3.0'
    version: '6.3.0'
    regenerate:
      # Get the submodules that we'll need as a host tool
      - args: ['./init-repository', '-f', '--module-subset', 'qtbase,qtsvg,qtimageformats,qtshadertools,qtlanguageserver,qtwayland']

tools:
  # We do a limited superbuild with only the needed modules of Qt6 to satisfy host tooling.
  - name: cross-qt6
    from_source: qt6
    tools_required:
      - cross-cmake
    configure:
      - args:
        - 'cmake'
        - '-GNinja'
        - '-DCMAKE_INSTALL_PREFIX=@PREFIX@'
        - '-DBUILD_SHARED_LIBS=ON'
        - '-DQT_BUILD_EXAMPLES=OFF'
        - '-DQT_BUILD_TESTS=OFF'
        - '@THIS_SOURCE_DIR@'
    compile:
      - args: ['cmake', '--build', '.', '--parallel', '6']
        # environ:
        #   # Chromium (aka qtwebengine) will OOM otherwise
        #   NINJAJOBS: '6'
    install:
      - args: ['cmake', '--install', '.']

packages:
  - name: qtbase6
    # architecture: '@OPTION:arch@'
    metadata:
      summary: The Qt6 base libraries
      description: This package provides the Qt6 base libraries, including QtCore, QtGui, QtWidgets and QtNetwork.
      spdx: 'GPL-2.0-only GPL-3.0-only LGPL-3.0-only GFDL-1.3-only'
      website: 'https://code.qt.io/cgit/qt/qtbase.git/'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['dev-qt']
    source:
      subdir: 'ports'
      git: 'https://code.qt.io/qt/qtbase.git'
      tag: 'v6.3.0'
      version: '6.3.0'
    tools_required:
      - cross-cmake
      - cross-qt6
      - cross-toolchain
    pkgs_required:
      - mlibc
      - zlib
      - zstd
      # - pcre2
      - double-conversion
      - libiconv
      # - icu
      # - glib
      # - libxkbcommon
      # - libinput
      # - libevdev
      # - mtdev
      # - mesa
      # - freetype
      # - fontconfig
      - libpng
      # - harfbuzz
      # - libx11
      # - libjpeg-turbo
      # - libsm
      # - libice
      # - libdrm
      # - libxcb
      # - xcb-util-image
      # - xcb-util-keysyms
      # - xcb-util-wm
      # - xcb-util-render-util
      - openssl
      # - wayland
      # - wayland-protocols
      # - libxcursor
      # - libxinerama
      # - libxrender
      # - libxi
      - sqlite
      # - brotli
      # - dbus
    configure:
      - args:
        - 'cmake'
        - '-GNinja'
        - '-DQT_HOST_PATH=@BUILD_ROOT@/tools/cross-qt6'
        - '-DCMAKE_INSTALL_PREFIX=@THIS_COLLECT_DIR@/usr'
        - '-DCMAKE_TOOLCHAIN_FILE=@SOURCE_ROOT@/scripts/CMakeToolchain-@OPTION:arch-triple@.txt'
        - '-DCMAKE_BUILD_TYPE=Debug'
        - '-DINSTALL_BINDIR=bin'
        - '-DINSTALL_INCLUDEDIR=include/qt6'
        - '-DINSTALL_LIBDIR=lib'
        - '-DINSTALL_ARCHDATADIR=lib/qt6'
        - '-DINSTALL_PLUGINSDIR=lib/qt6/plugins'
        - '-DINSTALL_LIBEXECDIR=lib/qt6/libexec'
        - '-DINSTALL_QMLDIR=lib/qt6/qml'
        - '-DINSTALL_DATADIR=share/qt6'
        - '-DINSTALL_DOCDIR=share/qt6-doc'
        - '-DINSTALL_TRANSLATIONSDIR=share/qt6/translations'
        - '-DINSTALL_SYSCONFDIR=/etc/xdg'
        - '-DINSTALL_MKSPECSDIR=lib/qt6/mkspecs'
        - '-DINSTALL_EXAMPLESDIR=share/qt6/examples'
        - '-DBUILD_SHARED_LIBS=ON'
        - '-DQT_BUILD_EXAMPLES=OFF'
        - '-DQT_BUILD_TESTS=OFF'
        - '-DFEATURE_concurrent=OFF'
        - '-DFEATURE_dbus=OFF'
        - '-DFEATURE_gui=OFF'
        - '-DFEATURE_network=OFF'
        - '-DFEATURE_printsupport=OFF'
        - '-DFEATURE_sql=OFF'
        - '-DFEATURE_testlib=OFF'
        - '-DFEATURE_widgets=OFF'
        - '-DFEATURE_libudev=OFF'
        - '-DFEATURE_icu=OFF'
        - '-DFEATURE_glib=ON'
        - '-DFEATURE_pcre2=OFF'
        - '-DFEATURE_xml=OFF'
        - '-DFEATURE_harfbuzz=OFF'
        - '-DFEATURE_xkbcommon=OFF'
        - '-DFEATURE_xkbcommon_x11=OFF'
        - '-DFEATURE_libinput=OFF'
        - '-DFEATURE_evdev=OFF'
        - '-DFEATURE_mtdev=OFF'
        - '-DFEATURE_egl=OFF'
        - '-DFEATURE_opengl=OFF'
        - '-DFEATURE_accessibility=OFF'
        - '-DFEATURE_xlib=OFF'
        - '-DFEATURE_xcb=OFF'
        - '-DFEATURE_xcb_xlib=OFF'
        - '-DFEATURE_eglfs_gbm=OFF'
        - '-DFEATURE_eglfs_egldevice=OFF'
        - '-DFEATURE_gtk3=OFF'
        - '-DFEATURE_system_sqlite=ON'
        - '-DFEATURE_cups=OFF'
        - '-DFEATURE_ssl=OFF'
        - '@THIS_SOURCE_DIR@'
        environ:
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
    build:
      - args: ['cmake', '--build', '.', '--parallel', '@PARALLELISM@']
      - args: ['cmake', '--install', '.']
      # Touch a file in empty directories to keep xbps happy
      - args: ['touch', '@THIS_COLLECT_DIR@/usr/lib/cmake/Qt6/QtBuildInternals/QtStandaloneTestTemplateProject/.keep']
      - args: ['touch', '@THIS_COLLECT_DIR@/usr/lib/cmake/Qt6/macos/.keep']
      - args: ['touch', '@THIS_COLLECT_DIR@/usr/lib/cmake/Qt6/ios/.keep']
